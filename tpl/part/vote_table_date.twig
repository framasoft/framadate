{% if best_choices is not iterable or best_choices is empty %}
    {% set best_choices = [0] %}
{% endif %}

<h3>
    {{__('Poll results', 'Votes of the poll')}}Â {% if hidden %}<i>({{ __('PollInfo', 'Results are hidden')}})</i>{% endif %}
    {% if accessGranted %}
        <a href="" data-toggle="modal" data-target="#hint_modal"><i class="glyphicon glyphicon-info-sign"></i></a>
    {% endif %}
</h3>


{% include 'part/scroll_left_right.twig' %}


<div id="tableContainer" class="tableContainer">
    <form action="{% if admin %}{{ poll_url(admin_poll_id, true) }}{% else %}{{ poll_url(poll_id) }}{% endif %}" method="POST" id="poll_form">
        <input type="hidden" name="control" value="{{ slots_hash }}"/>
        <table class="results">
            <caption class="sr-only">{{__('Poll results', 'Votes of the poll')}} {{ poll.title|raw}}</caption>
            <thead>
            {% if admin and not expired %}
                <tr class="hidden-print">
                    <th role="presentation"></th>
                    {% set headersDCount=0 %}
                    {% for slot in slots %}
                        {% for id, moment in slot.moments %}
                            <td headers="M{{ id }} D{{ headersDCount }} H{{ headersDCount }}">
                                <a href="{{poll_url(admin_poll_id, true, 'delete_column', slot.day ~ '@' ~ moment)}}"
                                   data-remove-confirmation="{{__('adminstuds', 'Confirm removal of the column.')}}"
                                   class="btn btn-link btn-sm remove-column"
                                   title="{{__('adminstuds', 'Remove the column')}} {{ slot.day }} - {{moment|raw}}">
                                    <i class="glyphicon glyphicon-remove text-danger"></i><span class="sr-only">{{__('Generic', 'Remove')}}</span>
                                </a>
                            </td>
                            {% set headersDCount = headersDCount + 1 %}
                        {% endfor %}
                    {% endfor %}
                    <td>
                        <a href="{{ poll_url(admin_poll_id, true, 'add_column') }}"
                           class="btn btn-link btn-sm" title="{{__('adminstuds', 'Add a column')}}">
                            <i class="glyphicon glyphicon-plus text-success"></i><span class="sr-only">{{__('Poll results', 'Add a column')}}</span>
                        </a>
                    </td>
                </tr>
            {% endif %}
            <tr>
                <th role="presentation"></th>
                {% set count_same = 0 %}
                {% set previous = 0 %}
                {% for id, slot in slots %}
                    {% set display = slot.day %}
                    {% if previous != 0 and previous != display %}
                        <th colspan="{{ count_same }}" class="bg-primary month" id="M{{ id }}">{{ previous }}</th>
                        {% set count_same = 0 %}
                    {% endif %}

                    {% set count_same = count_same + (slot.moments|length) %}

                    {% if loop.last %}
                        <th colspan="{{ count_same }}" class="bg-primary month" id="M{{ id }}">{{ display }}</th>
                    {% endif %}

                    {% set previous = display %}

                    {% for foo in 0..(slot.moments|length)-1 %}
                        {# append var='headersM' value=$id #}
                    {% endfor %}
                {% endfor %}
                <th></th>
            </tr>
            <tr>
                <th role="presentation"></th>
                {% for id, slot in slots %}
                    <th colspan="{{ slot.moments | length }}" class="bg-primary day" id="D{{ id }}">{{ slot.day }}</th>
                    {% for foo in 0..(slot.moments| length )-1 %}
                        {# append var='headersD' value=$id #}
                    {% endfor %}
                {% endfor %}
                <th></th>
            </tr>
            <tr>
                <th role="presentation"></th>
                {% set headersDCount = 0 %}
                {% set slots_raw = [] %}
                {% for slot in slots %}
                    {% for id, moment in slot.moments %}
                        <th colspan="1" class="bg-info" id="H{{ headersDCount }}">{{ moment|raw }}</th>
                        {# append var='headersH' value=$headersDCount #}
                        {% set headersDCount = headersDCount+1 %}
                        {% set slots_raw = slots_raw | merge(slot.day) %}
                    {% endfor %}
                {% endfor %}
                <th></th>
            </tr>
            </thead>
            <tbody>
            {% for vote in votes %}
                {# Edited line #}

                {% if editingVoteId == vote.uniqId and not expired %}
                <tr class="hidden-print">
                    <td class="bg-info btn-edit">
                        <div class="input-group input-group-sm" id="edit">
                            <span class="input-group-addon"><i class="glyphicon glyphicon-user"></i></span>
                            <input type="hidden" name="edited_vote" value="{{ vote.uniqId }}"/>
                            <input type="text" id="name" name="name" value="{{ vote.name|raw }}" class="form-control" title="{{__('Generic', 'Your name')}}" placeholder="{{__('Generic', 'Your name')}}" />

                        </div>
                    </td>


                    {% set k=0 %}
                    {% for slog in slots %}
                        {% for moment in slot.moments %}
                            {% set choice = vote.choices[k] %}


                            <td class="bg-info" headers="M{$headersM[$k]} D{$headersD[$k]} H{$headersH[$k]}">
                                <ul class="list-unstyled choice">
                                    <li class="yes">
                                        <input type="radio" id="y-choice-{$k}" name="choices[{$k}]" value="2" {% if choice == '2' %}checked {% endif %}/>
                                        <label class="btn btn-default btn-xs" for="y-choice-{$k}" title="{__('Poll results', 'Vote yes for')|html} {$slots_raw[$k]}">
                                            <i class="glyphicon glyphicon-ok"></i><span class="sr-only">{{__('Generic', 'Yes')}}</span>
                                        </label>
                                    </li>
                                    <li class="ifneedbe">
                                        <input type="radio" id="i-choice-{$k}" name="choices[{$k}]" value="1" {% if choice =='1' %}checked {% endif %}/>
                                        <label class="btn btn-default btn-xs" for="i-choice-{$k}" title="{__('Poll results', 'Vote ifneedbe for')|html} {$slots_raw[$k]}">
                                            (<i class="glyphicon glyphicon-ok"></i>)<span class="sr-only">{{__('Generic', 'Ifneedbe')}}</span>
                                        </label>
                                    </li>
                                    <li class="no">
                                        <input type="radio" id="n-choice-{$k}" name="choices[{$k}]" value="0" {% if choice=='0' %}checked {% endif %}/>
                                        <label class="btn btn-default btn-xs" for="n-choice-{$k}" title="{__('Poll results', 'Vote no for')|html} {$slots_raw[$k]}">
                                            <i class="glyphicon glyphicon-ban-circle"></i><span class="sr-only">{{ __('Generic', 'No')}}</span>
                                        </label>
                                    </li>
                                    <li class="hide">
                                        <input type="radio" id="n-choice-{$k}" name="choices[{$k}]" value=" " {% if choice != '2' and choice != '1' and choice != '0' %}checked {% endif %}/>
                                    </li>
                                </ul>
                            </td>

                            {% set k= k + 1 %}
                        {% endfor %}
                    {% endfor %}

                    <td class="btn-edit"><button type="submit" class="btn btn-success btn-xs" name="save" value="{$vote.id|html}" title="{__('Poll results', 'Save the choices')} {$vote.name|html}">{__('Generic', 'Save')}</button></td>

                </tr>
                {% elseif not hidden %}
                <tr>

                    {# Voted line #}

                    <th class="bg-info">{$vote.name|html}
					{if $slots gt 4}
						<span class="edit-username-left">
							<a href="{if $admin}{poll_url id=$poll.admin_id vote_id=$vote.uniqId admin=true}{else}{poll_url id=$poll.id vote_id=$vote.uniqId}{/if}" class="btn btn-default btn-sm" title="{__f('Poll results', 'Edit the line: %s', $vote.name)|html}">
                       		<i class="glyphicon glyphicon-pencil"></i><span class="sr-only">{__('Generic', 'Edit')}</span>
                       		</a>
					</span>
					{/if}
					</th>




                    {% set k=0 %}
                    {% for slot in slots %}
                      {% for moment in slot.moments %}
                        {% set choice = vote.choices[k] %}

                        {% if choice == '2' %}
                            <td class="bg-success text-success" headers="M{$headersM[$k]} D{$headersD[$k]} H{$k}"><i class="glyphicon glyphicon-ok"></i><span class="sr-only">{__('Generic', 'Yes')}</span></td>
                        {% elseif choice == '1' %}
                            <td class="bg-warning text-warning" headers="M{$headersM[$k]} D{$headersD[$k]} H{$k}">(<i class="glyphicon glyphicon-ok"></i>)<span class="sr-only">{__('Generic', 'Ifneedbe')}</span></td>
                        {% elseif choice == '0' %}
                            <td class="bg-danger text-danger" headers="M{$headersM[$k]} D{$headersD[$k]} H{$k}"><i class="glyphicon glyphicon-ban-circle"></i><span class="sr-only">{__('Generic', 'No')}</span></td>
                        {% else %}
                            <td class="bg-info" headers="M{$headersM[$k]} D{$headersD[$k]} H{$k}"><span class="sr-only">{__('Generic', 'Unknown')}</span></td>
                        {% endif %}

                        {% set k = k + 1 %}
                      {% endfor %}
                    {% endfor %}

                    {% if active and not expired and accessGranted and
                        (
                            poll.editable == constant('Framadate\Editable::EDITABLE_BY_ALL')
                            or admin
                            or (poll.editable == constant('Framadate\Editable::EDITABLE_BY_OWN') and editedVoteUniqueId == vote.uniqId)
                        )
                    %}
                        <td class="hidden-print">
                            <a href="{% if admin %}{{ poll_url(poll.admin_id, true, vote.uniqId) }}{% else %}{{ poll_url(poll.id, vote.uniqId) }}{% endif %}" class="btn btn-default btn-sm" title="{{__('Poll results', 'Edit the line: %s', vote.name)|raw}}">
                                <i class="glyphicon glyphicon-pencil"></i><span class="sr-only">{{__('Generic', 'Edit')}}</span>
                            </a>
                            {% if admin %}
                                <a href="{{poll_url(admin_poll_id, true, 'delete_vote', vote.id) }}"
                                   class="btn btn-default btn-sm"
                                   title="{{__('Poll results', 'Remove the line:')}} {{vote.name|raw}}">
                                    <i class="glyphicon glyphicon-remove text-danger"></i><span class="sr-only">{{__('Generic', 'Remove')}}</span>
                                </a>
                            {% endif %}
                        </td>
                    {% else %}
                        <td></td>
                    {% endif %}
                </tr>
                {% endif %}
            {% endfor %}

            {# Line to add a new vote #}

            {% if active and editingVoteId == 0 and not expired and accessGranted %}
                <tr id="vote-form" class="hidden-print">
                    <td class="bg-info btn-edit">
                        <div class="input-group input-group-sm">
                            <span class="input-group-addon"><i class="glyphicon glyphicon-user"></i></span>
                            <input type="text" id="name" name="name" class="form-control" title="{{__('Generic', 'Your name')}}" placeholder="{{__('Generic', 'Your name')}}" />
                        </div>
                    </td>


                    {% set i = 0 %}
                    {% for slot in slots %}
                        {% for moment in slot.moments %}

                            <td class="bg-info" headers="M{$headersM[$i]} D{$headersD[$i]} H{$headersH[$i]}">
                                <ul class="list-unstyled choice">
                                    {% if best_choices['y'][i] > poll.ValueMax or poll.ValueMax is null %}
                                        <li class="yes">
                                            <input type="radio" id="y-choice-{$i}" name="choices[{$i}]" value="2" />
                                            <label class="btn btn-default btn-xs" for="y-choice-{$i}" title="{__('Poll results', 'Vote yes for')|html} {$slot.day|date_format:$date_format.txt_short|html} - {$moment|html}">
                                                <i class="glyphicon glyphicon-ok"></i><span class="sr-only">{{__('Generic', 'Yes')}}</span>
                                            </label>
                                        </li>
                                        <li class="ifneedbe">
                                            <input type="radio" id="i-choice-{$i}" name="choices[{$i}]" value="1" />
                                            <label class="btn btn-default btn-xs" for="i-choice-{$i}" title="{__('Poll results', 'Vote ifneedbe for')|html} {$slot.day|date_format:$date_format.txt_short|html} - {$moment|html}">
                                                (<i class="glyphicon glyphicon-ok"></i>)<span class="sr-only">{{__('Generic', 'Ifneedbe')}}</span>
                                            </label>
                                        </li>

                				    {% endif %}

                                    <li class="no">
                                        <input type="radio" id="n-choice-{$i}" name="choices[{$i}]" value="0" />
                                        <label class="btn btn-default btn-xs startunchecked" for="n-choice-{$i}" title="{{__('Poll results', 'Vote no for')|raw}} {{slot.day}} - {{ moment|raw}}">
                                            <i class="glyphicon glyphicon-ban-circle"></i><span class="sr-only">{{__('Generic', 'No')}}</span>
                                        </label>
                                    </li>
                                    <li class="hide">
                                      <input type="radio" id="n-choice-{{i}}" name="choices[{{ i }}]" value=" " checked/>
                                    </li>
                                </ul>
                            </td>



                            {% set i = i + 1 %}
                        {% endfor %}
                    {% endfor %}
                    <td><button type="submit" class="btn btn-success btn-md" name="save" title="{__('Poll results', 'Save the choices')}">{{__('Generic', 'Save')}}</button></td>
                </tr>
            {% endif %}

            {% if not hidden %}
                {# Line displaying best moments #}
                {% set count_bests = 0 %}
                {% set max = max(best_choices['y']) %}
                {% if max > 0 %}
                    <tr id="addition">
                        <td>{{__('Poll results', 'Addition')}}<br/>
                            {{ votes|length}}
                            {% if (votes|length) == 1 %}
                                {{__('Poll results', 'polled user')}}
                            {% else %}
                                {{__('Poll results', 'polled users')}}
                            {% endif %}
                        </td>
                        {% for i, best_moment in best_choices['y'] %}
                            {% if max == best_moment %}
                                {% set count_bests = count_bests +1 %}
                                <td>
                                    <i class="glyphicon glyphicon-star text-info"></i>
                                    <span class="yes-count">{{ best_moment|raw}}</span>
                                    {% if best_choices['inb'][i]>0 %}
                                    <br/>
                                    <span class="small text-muted">
                                        (+<span class="inb-count">{{ best_choices['inb'][i]|raw}}</span>)
                                    </span>
                                    {% endif %}
                                </td>
                            {% elseif best_moment > 0 %}
                                <td>
                                    <span class="yes-count">{{ best_moment|raw}}</span>
                                    {% if best_choices['inb'][i] > 0 %}
                                        <br/>
                                        <span class="small text-muted">
                                            (+<span class="inb-count">{{ best_choices['inb'][i]|raw }}</span>)
                                        </span>
                                    {% endif %}
                                </td>
                            {% elseif best_choices['inb'][i] > 0 %}
                                <td>
                                    <br/>
                                    <span class="small text-muted">
                                        (+<span class="inb-count">{{best_choices['inb'][i]|raw}}</span>)
                                    </span>
                                </td>
                            {% else %}
                                <td></td>
                            {% endif %}
                        {% endfor %}
                    </tr>
                {% endif %}
            {% endif %}
            </tbody>
        </table>
    </form>
</div>

{% if not hidden and max > 0 %}
    <div class="row" aria-hidden="true">
        <div class="col-xs-12">
            <p class="text-center" id="showChart">
                <button class="btn btn-lg btn-default">
                    <span class="fa fa-fw fa-bar-chart"></span> {{__('Poll results', 'Display the chart of the results')}}
                </button>
            </p>
        </div>
    </div>
    <script type="text/javascript">
        $(document).ready(function () {
            $('#showChart').on('click', function() {
                $('#showChart')
                        .after("<h3>{{__('Poll results', 'Chart')}}</h3><canvas id=\"Chart\"></canvas>")
                        .remove();

                var resIfneedbe = [];
                var resYes = [];

                $('#addition').find('td').each(function () {
                    var inbCountText = $(this).find('.inb-count').text();
                    if(inbCountText != '' && inbCountText != undefined) {
                        resIfneedbe.push(inbCountText)
                    } else {
                        resIfneedbe.push(0);
                    }
                    var yesCountText = $(this).find('.yes-count').text();
                    if(yesCountText != '' && yesCountText != undefined) {
                        resYes.push(yesCountText)
                    } else {
                        resYes.push(0);
                    }
                });
                var cols = [
                {% for slot in slots %}
                    {% for moment in slot.moments %}
                        $('<div/>').html('{{ slot.day }} - {{ moment|raw }}').text(),
                    {% endfor %}
                {% endfor %}
                ];

                resIfneedbe.shift();
                resYes.shift();

                var barChartData = {
                    labels : cols,
                    datasets : [
                    {
                        label: "{__('Generic', 'Ifneedbe')}",
                        fillColor : "rgba(255,207,79,0.8)",
                        highlightFill: "rgba(255,207,79,1)",
                        barShowStroke : false,
                        data : resIfneedbe
                    },
                    {
                        label: "{__('Generic', 'Yes')}",
                        fillColor : "rgba(103,120,53,0.8)",
                        highlightFill : "rgba(103,120,53,1)",
                        barShowStroke : false,
                        data : resYes
                    }
                    ]
                };

                var ctx = document.getElementById("Chart").getContext("2d");
                window.myBar = new Chart(ctx).StackedBar(barChartData, {
                    responsive : true
                });
                return false;
            });
        });
    </script>

{% endif %}

{% if not hidden %}
    {# Best votes listing #}
    {% set max = max(best_choices['y']) %}
    {% if max > 0 %}
        <div class="row">
        {% if count_bests == 1 %}
            <div class="col-sm-12">
                <h3>{{__('Poll results', 'Best choice')}}</h3>
            </div>
            <div class="col-sm-6 col-sm-offset-3 alert alert-info">
                <p><i class="glyphicon glyphicon-star text-info"></i> {{__('Poll results', 'The best choice at this time is:')}}</p>
            </div>
        {% elseif count_bests > 1 %}
            <div class="col-sm-12">
                <h3>{__('Poll results', 'Best choices')}</h3>
            </div>
            <div class="col-sm-6 col-sm-offset-3 alert alert-info">
                <p><i class="glyphicon glyphicon-star text-info"></i> {{__('Poll results', 'The bests choices at this time are:')}}</p>
            </div>
        {% endif %}


        {% set i = 0 %}
        <ul class="list-unstyled">
            {% for slot in slots %}
                {% for moment in slot.moments %}
                    {% if best_choices['y'][i] == max %}
                        <li><strong>{{ slot.day}} - {{moment|raw}}</strong></li>
                    {% endif %}
                    {% set i = i+1 %}
                {% endfor %}
            {% endfor %}
        </ul>
        <p>{{__('Generic', 'with')}} <b>{max|raw}</b> {% if max == 1 %}{{__('Generic', 'vote')}}{% else %}{{__('Generic', 'votes')}}{% endif %}.</p>
    {% endif %}
{% endif %}
